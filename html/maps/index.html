<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        
        <!-- https://developers.google.com/sheets/api/samples/reading -->
        <!-- https://developers.google.com/maps/documentation/javascript/tutorial -->
        <!-- https://developers.google.com/maps/documentation/javascript/places#find_place_from_query -->
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZx2ObtBozwyOoFiH5Jx6D0XBJjMnNnqM&callback=initMap&libraries=places" async defer></script>

        <script type="text/javascript" src="local_api_key.js"></script>
        <style>
            /* Always set the map height explicitly to define the size of the div
            * element that contains the map. */
            #map {
                height: 100%;
            }
            /* Optional: Makes the sample page fill the window. */
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #progressbar {
                position: absolute;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: #fff;
                opacity: 0.7;
                z-index: 1;
            }
        </style>
        <script>
            var map;
            var service;
            var breweryArray = []
            var breweryTotal;

            // var API_KEY = "API_KEY";
            // var SHEET_ID = "SHEET_ID";

            // Initialize the google map
            function initMap() {
                var mapCenter = new google.maps.LatLng(40.5375761,-95.8688977);

                map = new google.maps.Map(document.getElementById('map'), {
                    center: mapCenter,
                    zoom: 4
                });

                getBreweries();
            }

            function getBreweries() {
                // Fetch list of breweries from the google sheet
                $.ajax({
                    url: "https://breweryapi.claytondavis.dev/api/brewery/gs/state/"+STATE_ABBREVIATION[state],
                    async: false,
                    method: "GET",    })
                .done(function( breweryapi_data ) {
                    console.log(breweryapi_data)
                    breweryTotal = breweryapi_data.length
                    for (var i = 0; i < breweryapi_data.length; i++) {
                        
                        if (breweryapi_data[i]['lat'] && breweryapi_data[i]['lon']) {
                            // Count of the brewery we just processed (starting with 1)
                            var brewNum = i + 1

                            console.log("Create Markers: "+breweryapi_data[i]['brewery_name'])
                            const myLatLng = { lat: breweryapi_data[i]['lat'], lng: breweryapi_data[i]['lon'] };
                            createMarkers(results, brewNum, brewery);

                            // Number/percentage for the status bar
                            var statusbarnum = Math.round((brewNum / breweryTotal) * 100)
                            // console.log("status: " +statusbarnum)
                            $( "#progressbar" ).progressbar({value: statusbarnum});

                            if (brewNum == breweryTotal) {
                                $( "#progressbar" ).hide();
                            }
                        } else {
                            var brewery = breweryapi_data[i]['brewery_name'] + " " + breweryapi_data[i]['state']
                            var request = {
                                query: brewery,
                                fields: ['formatted_address', 'name', 'geometry']
                            };

                            service = new google.maps.places.PlacesService(map);
                            service.findPlaceFromQuery(request, function callback(results, status) {
                                // If the status returns OK - process and create a marker
                                if (status == google.maps.places.PlacesServiceStatus.OK) {
                                    // Count of the brewery we just processed (starting with 1)
                                    var brewNum = i + 1

                                    console.log("Create Markers: "+brewery)
                                    createMarkers(results[0].geometry.location, brewNum, brewery);

                                    // Number/percentage for the status bar
                                    var statusbarnum = Math.round((brewNum / breweryTotal) * 100)
                                    // console.log("status: " +statusbarnum)
                                    $( "#progressbar" ).progressbar({value: statusbarnum});

                                    if (brewNum == breweryTotal) {
                                        $( "#progressbar" ).hide();
                                    }
                                } else {
                                    // If APi call returns error
                                    if (breweryArray.length != 0) {
                                        console.log("--ERROR--")
                                        console.log(brewery)
                                        console.log(results);
                                        console.log(status)
                                        // If over the query limit - sleep and try again
                                        if (status == "OVER_QUERY_LIMIT") {
                                            console.log("sleeping to try again")
                                            setTimeout(function(){ getPlaces(brewery, 1); }, 10000);
                                        }
                                    }
                                }
                            });
                        }
                    }
                })
            }

            

            function createMarkers(latLong, brewNum, brewName) {

                // Image for the marker
                var image = {
                    // url: place.icon,
                    url: "https://cdn4.iconfinder.com/data/icons/location-vol-4/128/location-11-512.png",
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(25, 25)
                };

                // Google maps marker
                var marker = new google.maps.Marker({
                    map: map,
                    icon: image,
                    title: brewName,
                    position: latLong
                });

                // List all breweries
                var li = document.createElement('li');
                li.textContent = brewNum + ") " + brewName + " - " + places.length;
                document.getElementById('places').appendChild(li);

            }
        </script>
    </head>

    <body>
        <div id="map"></div>
        Return to <a href="/">main page</a>
        <div id="places"></div>
        <div id="progressbar"></div>
    </body>


</html>